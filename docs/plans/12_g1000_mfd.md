# Plan 12 — G1000 Multi-Function Display (MFD)

**Phase:** 6b
**Depends on:** Plans 11 (PFD architecture), 08 (map engine), 09 (overlays), 04 (nav DB)
**Blocks:** Plan 13 (controls navigate MFD pages)

---

## Goals

Implement all G1000 MFD pages rendered at 1280×800 logical resolution:
- Full-screen moving map with TAWS (G-11)
- Engine Indication System strip (G-12)
- Flight Plan page (G-13)
- Procedure Loading pages (G-14)
- Nearest pages (G-15)
- AUX pages (G-16)
- Terrain page (G-17)
- Traffic page (G-18)

Requirements covered: G-11 through G-18.

---

## MFD Page Architecture

The MFD is a **page-based display**. Pages are selected by the FMS knob (Plan 13) and softkeys.

```kotlin
// rendering/g1000/mfd/MfdPageManager.kt

enum class MfdPage {
    MAP, ENGINE_MAP, FPL, PROC, NRST_AIRPORTS, NRST_VORS, NRST_NDBS,
    AUX_TRIP, AUX_UTILITY, AUX_GPS_STATUS, AUX_SYSTEM_STATUS,
    TERRAIN, TRAFFIC
}

class MfdPageManager(private val renderer: MfdRenderer) {
    var activePage: MfdPage = MfdPage.MAP
        set(value) {
            field = value
            renderer.onPageChanged(value)
        }

    fun onFmsOuterKnob(delta: Int) {
        // Cycle through page groups
        val groups = listOf(MfdPage.MAP, MfdPage.FPL, MfdPage.PROC, MfdPage.NRST_AIRPORTS,
                            MfdPage.AUX_TRIP, MfdPage.TERRAIN, MfdPage.TRAFFIC)
        activePage = groups.cycle(delta)
    }

    fun onFmsInnerKnob(delta: Int) {
        // Cycle within current page group (e.g., NRST sub-pages)
    }
}
```

---

## 1. G-11 — MFD Moving Map (Full Screen)

The MFD map reuses the `MapRenderer` and overlay renderers from Plans 08–09. MFD-specific additions:

### EIS strip (always visible on left side)
The Engine Indication System strip occupies the left 200px of the MFD at all times, even on the map page. This reduces the available map width to 1080px.

### TAWS colour scheme (must match CRG Section 5)
```kotlin
object G1000TawsColours {
    // These are specific to the G1000 — different from generic TAWS
    val TERRAIN_SOLID_RED     = Color(0xFFFF0000)   // <100ft clearance
    val TERRAIN_SOLID_YELLOW  = Color(0xFFFFFF00)   // 100-500ft clearance
    val TERRAIN_SOLID_GREEN   = Color(0xFF00CC00)   // 500-2000ft clearance
    val TERRAIN_NO_THREAT     = Color(0xFF000000)   // >2000ft above, transparent
}
```

### Map range (G1000 range steps)
```kotlin
val G1000_RANGE_STEPS_NM = intArrayOf(1, 2, 3, 4, 5, 7, 10, 15, 20, 25, 30,
                                       40, 50, 75, 100, 150, 200, 300, 500, 1000)
```

### BARO ALTM data overlay
Current barometric altitude shown in bottom-right corner of map at all zoom levels.

---

## 2. G-12 — Engine Indication System (EIS) Strip

The EIS strip is a fixed 200×800px column on the left side of the MFD. Always visible.

```
┌─────────────────────────────┐
│ RPM                 2350    │
│ ══════════════╗ ───────     │
│                             │
│ MAP              22.5 inHg  │
│ ═══════════════── ──────    │
│                             │
│ FF               8.5 LPH   │
│ OIL T            85 °C     │
│ OIL P            55 PSI    │
│                             │
│ EGT/CHT  cyl1-6 bar graph  │
│                             │
│ FUEL L         40.5 L      │
│ FUEL R         40.5 L      │
│                             │
│ VOLTS          14.2 V      │
│ AMPS            5.2 A      │
└─────────────────────────────┘
```

Fuel flow displayed in LPH (SA default) or GPH (user-selectable).

Peak EGT detection for lean-assist:
```kotlin
class EgtLeanAssist {
    private val peakEgt = FloatArray(6) { 0f }
    private var leanAssistActive = false

    fun update(egt: FloatArray) {
        if (!leanAssistActive) return
        for (i in egt.indices) {
            if (egt[i] > peakEgt[i]) peakEgt[i] = egt[i]
        }
    }

    fun getPeakCylinder(): Int = peakEgt.indexOfMax()

    // Highlight peak cylinder in the bar graph
    fun isCylinderAtPeak(index: Int, current: FloatArray): Boolean =
        abs(current[index] - peakEgt[index]) < 5f  // within 5°C of peak
}
```

---

## 3. G-13 — Flight Plan Page (FPL)

Layout matches G1000 CRG FPL page exactly:

```
┌────────────────────────────────────────────────────────────────────────┐
│ ACTIVE FLIGHT PLAN                                          GPS DTK  BRG│
│ ─────────────────                                                       │
│  FAOR       5558ft        ──    ──        ──     ──                     │
│ ►TEBSA      FL130     N871  127°   142NM  1:03  01:03                  │
│  FACT       433ft      Z30  250°   598NM  4:12  5:15                   │
│                                                                         │
│  END OF FLIGHT PLAN                                                     │
└────────────────────────────────────────────────────────────────────────┘
```

Columns: Identifier | Altitude | Airway | DTK | DIS | ETE | ETA

```kotlin
// rendering/g1000/mfd/FplPageRenderer.kt

class FplPageRenderer(private val fontAtlas: FontAtlas) {
    // Cursor operations via FMS knob (Plan 13):
    //   - Outer ring: move cursor up/down
    //   - Inner disc: cycle cursor field value
    //   - ENT: confirm
    //   - CLR: cancel
    //   - D→ key: direct-to selected waypoint

    fun draw(plan: FlightPlan, cursorIndex: Int?, snapshot: SimSnapshot?, mvp: Matrix4f) {
        // Row height: 40px (matches CRG proportions at 800px height)
        // Active leg: cyan highlight bar behind row
        // Cursor row: white highlight
        // Font: monospaced, 18px height
    }
}
```

---

## 4. G-14 — Procedure Loading Pages

```kotlin
// rendering/g1000/mfd/ProcPageRenderer.kt

sealed class ProcSelection {
    object None : ProcSelection()
    data class Sid(val identifier: String, val runway: String?, val transition: String?) : ProcSelection()
    data class Star(val identifier: String, val runway: String?, val transition: String?) : ProcSelection()
    data class Approach(val type: String, val runway: String) : ProcSelection()
}

class ProcPageRenderer {
    // PROC menu pages:
    //   Page 1: SID selection (list from Navigraph DB)
    //   Page 2: STAR selection
    //   Page 3: Approach selection

    fun draw(page: ProcPage, navDb: EfbDatabase, mvp: Matrix4f) {
        // Scrollable list of procedure identifiers
        // Runway selector (sub-page)
        // Preview diagram: render procedure waypoints as line segments on mini-map
        // "LOAD?" confirmation
    }
}
```

On load: procedure waypoints inserted into active FPL at correct position.

---

## 5. G-15 — Nearest Pages (NRST)

Sub-pages:
- NRST AIRPORTS — nearest 15 airports with BRG/DIS
- NRST VOR
- NRST NDB
- NRST INT (intersections)
- NRST USR (user waypoints)

```kotlin
// rendering/g1000/mfd/NrstPageRenderer.kt

class NrstPageRenderer(private val navDb: EfbDatabase) {

    suspend fun loadNearestAirports(ownship: LatLon): List<AirportWithDistance> =
        navDb.airportDao()
            .nearbyAirports(SpatialQuery.nearbyAirports(ownship, 200.0))
            .map { AirportWithDistance(it, GreatCircle.distanceNm(ownship, it.latLon)) }
            .sortedBy { it.distanceNm }
            .take(15)

    fun draw(airports: List<AirportWithDistance>, cursor: Int, mvp: Matrix4f) {
        // Table layout per CRG: IDENT | BRG | DIS | ELEV | APR (approach types)
    }
}
```

---

## 6. G-16 — AUX Pages

### AUX Trip Planning
```kotlin
data class TripPlanData(
    val destination: Waypoint?,
    val distNm: Double,
    val eteHrMin: String,
    val fuelRequiredKg: Float,
    val fuelOnBoardKg: Float,
    val estimatedArrivalTime: String,
)
```

### AUX Utility
- Count-up timer (from engine start or takeoff)
- Count-down timer
- Fuel endurance: `fuelKg / fuelFlowKgHr` in hours:minutes

### AUX GPS Status
Simulated — X-Plane always has GPS fix. Show:
- "Position: 3D NAV"
- "RAIM available: YES"
- Simulated satellite count (12 always-good)

### AUX System Status
```
Plugin: Connected | Disconnected
Protocol: PLUGIN | GDL-90 | UDP
Latency: 45ms
Last Data: 0.1s ago
AIRAC Cycle: 2401
Nav DB: OurAirports v2024-01
```

---

## 7. G-17 — Terrain Page

Dedicated full-screen terrain awareness page. Reuses `TawsRenderer` from Plan 09 but in plan-view (top-down) rather than overlay mode.

```kotlin
// rendering/g1000/mfd/TerrainPageRenderer.kt

class TerrainPageRenderer(private val tawsRenderer: TawsRenderer) {
    // Centre view on ownship
    // North-up orientation
    // Terrain coloured by TAWS LUT (same as map TAWS)
    // Obstacles shown as yellow triangles
    // FLTA (Forward Looking Terrain Avoidance) alert strip at top
    // PDA (Premature Descent Alert) logic

    fun checkPda(snapshot: SimSnapshot, approach: ApproachProcedure?): Boolean {
        // Alert if: gear-down speed AND below glidepath AND terrain within 0.5nm
        return approach != null &&
               snapshot.ias_kts < 160f &&  // gear-down speed proxy
               snapshot.elevation_m * 3.281f < (approach.glideslopeAlt(snapshot) - 300f)
    }
}
```

---

## 8. G-18 — Traffic Page

```kotlin
// rendering/g1000/mfd/TrafficPageRenderer.kt

class TrafficPageRenderer {
    // Ownship at center (or offset in direction of travel)
    // Traffic within 50nm, ±2700ft vertical
    // Per target: diamond symbol + altitude tag (+/-xxx ft) + velocity vector
    // TA (amber): <0.5nm lateral / <200ft vertical
    // RA (red): <0.2nm lateral / <100ft vertical

    fun draw(snapshot: SimSnapshot, mvp: Matrix4f) {
        val ownAlt = snapshot.elevation_m * 3.281f
        for (i in 0 until snapshot.traffic_count) {
            val trafficAlt = snapshot.traffic_ele_m[i] * 3.281f
            val relAlt = trafficAlt - ownAlt
            val dist = GreatCircle.distanceNm(
                LatLon(snapshot.latitude, snapshot.longitude),
                LatLon(snapshot.traffic_lat[i].toDouble(), snapshot.traffic_lon[i].toDouble()))

            val alertLevel = when {
                dist < 0.2 && abs(relAlt) < 100f -> AlertLevel.RA
                dist < 0.5 && abs(relAlt) < 200f -> AlertLevel.TA
                else -> AlertLevel.OTHER
            }
            drawTrafficTarget(snapshot, i, relAlt, alertLevel, mvp)
        }
    }
}
```

---

## MFD FBO Pipeline

```
MFD GLSurfaceView (1280×800)
    │
    ├── EIS Strip Renderer (200×800px, left column, always active)
    │
    └── Page Content Area (1080×800px, right of EIS)
          ├── MAP page:
          │     ├── TileRenderer (base map)
          │     ├── TawsRenderer (terrain)
          │     ├── AirportOverlay, NavaidOverlay, AirspaceOverlay
          │     ├── ActiveRouteRenderer
          │     └── TrafficOverlayRenderer
          │
          ├── FPL page:
          │     └── FplPageRenderer (text atlas)
          │
          ├── PROC page:
          │     └── ProcPageRenderer (list + preview diagram)
          │
          ├── NRST pages:
          │     └── NrstPageRenderer
          │
          ├── AUX pages:
          │     └── AuxPageRenderer (text + simple graphics)
          │
          ├── TERRAIN page:
          │     └── TerrainPageRenderer (top-down TAWS)
          │
          └── TRAFFIC page:
                └── TrafficPageRenderer
```

---

## Tests

```kotlin
@Test
fun mfdRangeSteps_contain1000nm() {
    assertTrue(G1000_RANGE_STEPS_NM.contains(1000))
    assertTrue(G1000_RANGE_STEPS_NM.contains(1))
}

@Test
fun eisFuelFlow_saDefaultLph() {
    val lph = kgSecToLph(kgSec = 0.02f, fuelType = FuelType.AVGAS)
    // Default display should be LPH for SA
    val display = EisFormatter.fuelFlow(lph, unit = FuelFlowUnit.LPH)
    assertTrue(display.contains("LPH"))
}

@Test
fun trafficPage_taAlert() {
    val snapshot = testSnapshot(traffic = listOf(
        TrafficTarget(lat = -26.139f, lon = 28.247f, eleM = 1700f)  // ~0.3nm, <200ft diff
    ))
    val page = TrafficPageRenderer()
    val alert = page.getAlertLevel(snapshot, index = 0)
    assertEquals(AlertLevel.TA, alert)
}

@Test
fun pdaLogic_triggersOnApproach() {
    // Simulate being 300ft below glidepath with terrain nearby
    val triggered = TerrainPageRenderer().checkPda(
        snapshot = approachSnapshotBelow(),
        approach = testApproach()
    )
    assertTrue(triggered)
}

@Test
fun fplPage_activeLegHighlighted() {
    val plan = testFlightPlan(activeLeg = 1)
    // Assert that waypoint at index 1 has cyan highlight in rendered output
}
```

---

## Acceptance Criteria Mapping

| Req | Satisfied by |
|---|---|
| G-11 (TAWS colours per CRG, obstacle symbols) | `TawsRenderer` + `G1000TawsColours` |
| G-12 (EIS strip, LPH default, lean-assist) | `EisRenderer`, `EgtLeanAssist` |
| G-13 (FPL page per CRG, cursor navigation) | `FplPageRenderer`, cursor state |
| G-14 (PROC pages, SA procedures, preview) | `ProcPageRenderer`, Navigraph DB |
| G-15 (NRST airports <500ms, SA strips) | `NrstPageRenderer`, R-tree query |
| G-16 (AUX: trip, utility, GPS, system) | `AuxPageRenderer` sub-pages |
| G-17 (terrain page, PDA, Drakensberg) | `TerrainPageRenderer.checkPda()` |
| G-18 (traffic, TA/RA alerting) | `TrafficPageRenderer` with alert levels |
